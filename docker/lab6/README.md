# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ6: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–¶–µ–ª—å**: –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Apache Superset. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Apache Pinot –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –±—ã—Å—Ç—Ä–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ç–æ–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –ò–°–¢–û–ß–ù–ò–ö–ò –î–ê–ù–ù–´–• (Labs 1-5)                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Kafka Topic: moex.current_prices (Lab 5)              ‚îÇ
‚îÇ  Hive Table: moex_data.trades (Lab 3)                  ‚îÇ
‚îÇ  Hive Table: moex_data.trade_volumes_hourly (Lab 4)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ               ‚îÇ
                     ‚Üì               ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Apache Pinot     ‚îÇ   ‚îÇ Apache Hive  ‚îÇ
         ‚îÇ  (Real-time OLAP) ‚îÇ   ‚îÇ (Batch Data) ‚îÇ
         ‚îÇ                   ‚îÇ   ‚îÇ              ‚îÇ
         ‚îÇ  Table:           ‚îÇ   ‚îÇ  Tables:     ‚îÇ
         ‚îÇ  current_prices   ‚îÇ   ‚îÇ  - trades    ‚îÇ
         ‚îÇ                   ‚îÇ   ‚îÇ  - volumes   ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ                     ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚Üì
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ  Apache Superset     ‚îÇ
                  ‚îÇ  (Visualization)     ‚îÇ
                  ‚îÇ                      ‚îÇ
                  ‚îÇ  Dashboards:         ‚îÇ
                  ‚îÇ  1. Batch Analytics  ‚îÇ
                  ‚îÇ  2. Real-time Prices ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ü–æ—Ä—Ç—ã |
|-----------|-----------|--------|-------|
| **Real-time OLAP** | Apache Pinot | 1.0.0 | 9001 (Controller), 8099 (Broker), 8098 (Server) |
| **Visualization** | Apache Superset | 3.0.0 | 8089 |
| **Metadata DB** | PostgreSQL | 14-alpine | 5433 |
| **Coordination** | Zookeeper | 3.7 | 2182 |

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
docker/lab6/
‚îú‚îÄ‚îÄ docker-compose.yml              # –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã Lab 6
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md                       # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ pinot-configs/                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Pinot
‚îÇ   ‚îú‚îÄ‚îÄ current_prices_schema.json  # Schema –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
‚îÇ   ‚îî‚îÄ‚îÄ current_prices_table.json   # Table config (Kafka stream)
‚îÇ
‚îú‚îÄ‚îÄ superset-configs/               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Superset
‚îÇ   ‚îú‚îÄ‚îÄ superset_config.py          # Custom config
‚îÇ   ‚îî‚îÄ‚îÄ databases.yaml              # Database connections
‚îÇ
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ start.sh                    # üöÄ All-in-one –∑–∞–ø—É—Å–∫
    ‚îú‚îÄ‚îÄ stop.sh                     # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
    ‚îú‚îÄ‚îÄ setup-pinot.sh              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Pinot
    ‚îú‚îÄ‚îÄ setup-superset.sh           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Superset
    ‚îî‚îÄ‚îÄ test.sh                     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **Labs 1-5 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã** (Kafka, Hive, –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã)
2. **Docker –∏ Docker Compose**
3. **–ú–∏–Ω–∏–º—É–º 6 GB RAM –¥–ª—è Docker**

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ prerequisites

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:

```bash
# Kafka (Lab 1-2)
cd docker/kafka
docker-compose ps

# HDFS + Hive (Lab 3)
cd ../lab3
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Hive
docker exec -it hive-server /opt/hive/bin/beeline -u jdbc:hive2://localhost:10000 -n root \
  -e "USE moex_data; SELECT COUNT(*) FROM trades;"
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0 –∑–∞–ø–∏—Å–µ–π –≤ Hive.

### –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ Lab 6 (–≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!)

```bash
cd docker/lab6
./scripts/start.sh
```

**–°–∫—Ä–∏–ø—Ç `start.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç prerequisites (Kafka, network)
2. ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã (Pinot, Superset, PostgreSQL)
3. ‚úÖ –°–æ–∑–¥–∞—ë—Ç Pinot —Ç–∞–±–ª–∏—Ü—É `current_prices`
4. ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Superset database connections
5. ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥—Ä–∞–π–≤–µ—Ä—ã (pyhive, pinotdb)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~3-5 –º–∏–Ω—É—Ç

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
./scripts/test.sh
```

### –®–∞–≥ 4: –û—Ç–∫—Ä—ã—Ç—å Superset

–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: **http://localhost:8089**

**–õ–æ–≥–∏–Ω:** `admin`
**–ü–∞—Ä–æ–ª—å:** `admin`

---

## üé® –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–æ–≤

### Dashboard 1: Batch Analytics (Hive –¥–∞–Ω–Ω—ã–µ)

#### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥–∞–Ω–Ω—ã–º

1. –í Superset –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Lab**
2. –í—ã–±–µ—Ä–∏—Ç–µ database: **Apache Hive (Batch Data)**
3. –í—ã–±–µ—Ä–∏—Ç–µ schema: **moex_data**

#### –ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤

**1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
```sql
SELECT
    COUNT(*) as total_trades,
    COUNT(DISTINCT secid) as unique_instruments,
    SUM(value) as total_volume
FROM trades;
```

**2. –¢–æ–ø-10 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–¥–µ–ª–æ–∫:**
```sql
SELECT
    secid,
    COUNT(*) as trade_count,
    SUM(value) as total_volume
FROM trades
GROUP BY secid
ORDER BY trade_count DESC
LIMIT 10;
```

**3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ BUY vs SELL:**
```sql
SELECT
    buysell,
    COUNT(*) as count,
    SUM(value) as volume
FROM trades
WHERE buysell IN ('B', 'S')
GROUP BY buysell;
```

**4. –ü–æ—á–∞—Å–æ–≤—ã–µ –æ–±—ä–µ–º—ã —Ç–æ—Ä–≥–æ–≤ (–∏–∑ MapReduce —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤):**
```sql
SELECT *
FROM trade_volumes_hourly
ORDER BY hour_start DESC
LIMIT 100;
```

**5. –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ —Å–¥–µ–ª–æ–∫:**
```sql
SELECT
    substr(tradetime, 1, 13) as hour,
    COUNT(*) as trade_count
FROM trades
GROUP BY substr(tradetime, 1, 13)
ORDER BY hour;
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π

1. **Big Number** - Total Trades
   - Metric: `COUNT(*)`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å 1

2. **Bar Chart** - Top Instruments
   - Dimension: `secid`
   - Metric: `COUNT(*)` –∏–ª–∏ `SUM(value)`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å 2

3. **Pie Chart** - BUY vs SELL
   - Dimension: `buysell`
   - Metric: `COUNT(*)`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å 3

4. **Line Chart** - Trade Volume Over Time
   - X-axis: `hour` (temporal)
   - Y-axis: `SUM(value)`
   - Group by: `secid` (–¥–ª—è multiple lines)

### Dashboard 2: Real-time Monitoring (Pinot –¥–∞–Ω–Ω—ã–µ)

#### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥–∞–Ω–Ω—ã–º

1. –í Superset –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Lab**
2. –í—ã–±–µ—Ä–∏—Ç–µ database: **Apache Pinot (Streaming Data)**
3. –í—ã–±–µ—Ä–∏—Ç–µ table: **current_prices**

#### –ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è Pinot

**1. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º:**
```sql
SELECT
    secid,
    current_price,
    buy_avg,
    sell_avg,
    timestamp
FROM current_prices
ORDER BY timestamp DESC
LIMIT 20
```

**2. –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:**
```sql
SELECT
    secid,
    current_price,
    timestamp
FROM current_prices
WHERE secid = 'SBER'
ORDER BY timestamp DESC
LIMIT 1
```

**3. –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å:**
```sql
SELECT
    secid,
    current_price,
    timestamp
FROM current_prices
WHERE timestamp > ago('PT1H')
ORDER BY timestamp
```

**4. –°–ø—Ä–µ–¥ BUY/SELL:**
```sql
SELECT
    secid,
    buy_avg,
    sell_avg,
    (buy_avg - sell_avg) as spread,
    timestamp
FROM current_prices
WHERE buy_avg IS NOT NULL AND sell_avg IS NOT NULL
ORDER BY timestamp DESC
LIMIT 50
```

**5. –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º:**
```sql
SELECT
    secid,
    AVG(current_price) as avg_price,
    MIN(current_price) as min_price,
    MAX(current_price) as max_price,
    COUNT(*) as data_points
FROM current_prices
GROUP BY secid
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π

1. **Big Number with Trend** - Current Price
   - Metric: `current_price`
   - Filter: `secid = 'SBER'` (–≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
   - **Enable Auto Refresh:** 10 seconds

2. **Time Series Chart** - Price Dynamics
   - X-axis: `timestamp`
   - Y-axis: `current_price`
   - Group by: `secid`
   - **Enable Auto Refresh:** 10 seconds

3. **Dual Line Chart** - BUY vs SELL
   - X-axis: `timestamp`
   - Y-axis: `buy_avg`, `sell_avg`
   - **Enable Auto Refresh:** 10 seconds

4. **Table** - Latest Prices
   - Columns: `secid`, `current_price`, `buy_avg`, `sell_avg`, `timestamp`
   - Order by: `timestamp DESC`
   - **Enable Auto Refresh:** 10 seconds

5. **Heatmap** - Price Activity
   - Rows: `secid`
   - Columns: Time buckets
   - Metric: `COUNT(*)` (–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

---

## üåê Web UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

| –°–µ—Ä–≤–∏—Å | URL | Credentials | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|-----|-------------|----------|
| **Superset** | http://localhost:8089 | admin / admin | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–∞—à–±–æ—Ä–¥—ã |
| **Pinot Console** | http://localhost:9001 | - | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Pinot, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **Kafka UI** | http://localhost:8080 | - | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Kafka (–∏–∑ Lab 1-2) |
| **HDFS NameNode** | http://localhost:9870 | - | –°—Ç–∞—Ç—É—Å HDFS (–∏–∑ Lab 3) |
| **YARN** | http://localhost:8088 | - | –°—Ç–∞—Ç—É—Å YARN (–∏–∑ Lab 4) |
| **Spark Master** | http://localhost:8083 | - | –°—Ç–∞—Ç—É—Å Spark (–∏–∑ Lab 5) |
| **NiFi** | http://localhost:8082/nifi | admin / adminadminadmin | Dataflow (–∏–∑ Lab 3) |

---

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose logs -f

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
docker-compose logs -f pinot-controller
docker-compose logs -f superset
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
docker-compose restart pinot-controller
docker-compose restart superset
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
./scripts/stop.sh

# –ò–ª–∏ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
docker-compose down -v
```

### –û—á–∏—Å—Ç–∫–∞ Pinot —Ç–∞–±–ª–∏—Ü

```bash
# –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
curl -X DELETE http://localhost:9001/tables/current_prices

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
./scripts/setup-pinot.sh
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
./scripts/test.sh
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- ‚úÖ Pinot Controller health
- ‚úÖ Pinot Broker health
- ‚úÖ –ù–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã `current_prices`
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Pinot
- ‚úÖ Superset health
- ‚úÖ Superset PostgreSQL
- ‚úÖ Kafka topic `moex.current_prices`
- ‚úÖ –í—Å–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Pinot

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health
curl http://localhost:9001/health

# –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
curl http://localhost:9001/tables

# –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"sql":"SELECT * FROM current_prices LIMIT 10"}' \
  http://localhost:8099/query/sql
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Superset

```bash
# Health check
curl http://localhost:8089/health

# –°–ø–∏—Å–æ–∫ databases (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
curl -u admin:admin http://localhost:8089/api/v1/database/
```

---

## üìä –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. Apache Hive (Batch Data)

**Connection String:** `hive://hive:10000/moex_data`

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

| –¢–∞–±–ª–∏—Ü–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|---------|----------|----------|
| `trades` | –í—Å–µ —Å–¥–µ–ª–∫–∏ —Å –±–∏—Ä–∂–∏ | Lab 3 (NiFi ‚Üí Hive) |
| `trade_volumes_hourly` | –ü–æ—á–∞—Å–æ–≤—ã–µ –æ–±—ä–µ–º—ã —Ç–æ—Ä–≥–æ–≤ | Lab 4 (MapReduce) |

**–°—Ö–µ–º–∞ `trades`:**
```
tradeno BIGINT
tradetime STRING
secid STRING
boardid STRING
price DOUBLE
quantity BIGINT
value DOUBLE
buysell STRING
period STRING
tradingsession STRING
systime STRING
ts_offset BIGINT
```

**–°—Ö–µ–º–∞ `trade_volumes_hourly`:**
```
secid STRING
hour_start STRING
hour_end STRING
total_volume DOUBLE
```

### 2. Apache Pinot (Streaming Data)

**Connection String:** `pinot://pinot-broker:8099/query?controller=http://pinot-controller:9001/`

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

| –¢–∞–±–ª–∏—Ü–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|---------|----------|----------|
| `current_prices` | –¢–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ | Lab 5 (Spark Streaming ‚Üí Kafka ‚Üí Pinot) |

**–°—Ö–µ–º–∞ `current_prices`:**
```
secid STRING            -- –ö–æ–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (SBER, GAZP, ...)
current_price DOUBLE    -- –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (—Å—Ä–µ–¥–Ω–µ–µ BUY –∏ SELL)
buy_avg DOUBLE          -- –°—Ä–µ–¥–Ω—è—è –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ BUY
sell_avg DOUBLE         -- –°—Ä–µ–¥–Ω—è—è –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ SELL
timestamp LONG          -- –í—Ä–µ–º—è —Ä–∞—Å—á—ë—Ç–∞ (milliseconds)
window_start STRING     -- –ù–∞—á–∞–ª–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
window_end STRING       -- –ö–æ–Ω–µ—Ü –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
```

---

## ‚ùó Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Pinot Controller –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
```
curl: (7) Failed to connect to localhost port 9001
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   ```bash
   docker logs pinot-controller
   ```
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Zookeeper –∑–∞–ø—É—â–µ–Ω:
   ```bash
   docker ps | grep pinot-zookeeper
   ```
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:
   ```bash
   docker-compose restart pinot-zookeeper pinot-controller
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: Pinot –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ Kafka

**–°–∏–º–ø—Ç–æ–º—ã:**
```
SELECT COUNT(*) FROM current_prices;
-- Result: 0 rows
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
1. ‚úÖ Kafka –∑–∞–ø—É—â–µ–Ω:
   ```bash
   docker ps | grep moex-kafka
   ```
2. ‚úÖ –¢–æ–ø–∏–∫ `moex.current_prices` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
   ```bash
   docker exec moex-kafka kafka-topics --list --bootstrap-server localhost:9092 | grep current_prices
   ```
3. ‚úÖ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–æ–ø–∏–∫–µ:
   ```bash
   docker exec moex-kafka kafka-console-consumer \
     --bootstrap-server localhost:9092 \
     --topic moex.current_prices \
     --max-messages 5
   ```
4. ‚úÖ Spark Streaming job (Lab 5) –∑–∞–ø—É—â–µ–Ω:
   ```bash
   curl http://localhost:8083/json/ | jq '.activeapps'
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: Superset –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Hive

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Connection failed: Could not connect to hive
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ HiveServer2 –∑–∞–ø—É—â–µ–Ω:
   ```bash
   docker ps | grep hive-server
   ```
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Hive:
   ```bash
   docker exec -it hive-server /opt/hive/bin/beeline \
     -u jdbc:hive2://localhost:10000 \
     -n root \
     -e "SHOW DATABASES;"
   ```
3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥—Ä–∞–π–≤–µ—Ä:
   ```bash
   docker exec superset pip install --upgrade pyhive[hive] thrift thrift-sasl
   docker-compose restart superset
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: Superset –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Pinot

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Connection failed: Could not connect to pinot
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Pinot Broker:
   ```bash
   curl http://localhost:8099/health
   ```
2. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥—Ä–∞–π–≤–µ—Ä:
   ```bash
   docker exec superset pip install --upgrade pinotdb
   docker-compose restart superset
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å connection string:
   ```
   pinot://pinot-broker:8099/query?controller=http://pinot-controller:9001/
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: Superset admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker exec -it superset superset fab create-admin \
  --username admin \
  --firstname Admin \
  --lastname User \
  --email admin@superset.com \
  --password admin
```

### –ü—Ä–æ–±–ª–µ–º–∞: Out of Memory

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å –¥–ª—è Docker (–º–∏–Ω–∏–º—É–º 6 GB)

**macOS/Windows:**
- Docker Desktop ‚Üí Settings ‚Üí Resources ‚Üí Memory ‚Üí 8 GB

**Linux:**
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ RAM

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### Pinot

```bash
# –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
curl http://localhost:9001/tables | jq

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–±–ª–∏—Ü–µ
curl http://localhost:9001/tables/current_prices | jq

# –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
curl -X DELETE http://localhost:9001/tables/current_prices

# SQL –∑–∞–ø—Ä–æ—Å
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"sql":"SELECT COUNT(*) FROM current_prices"}' \
  http://localhost:8099/query/sql | jq
```

### Superset

```bash
# –°–æ–∑–¥–∞—Ç—å admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
docker exec superset superset fab create-admin \
  --username admin \
  --firstname Admin \
  --lastname User \
  --email admin@superset.com \
  --password admin

# Database upgrade
docker exec superset superset db upgrade

# Init Superset
docker exec superset superset init

# –°–ø–∏—Å–æ–∫ users
docker exec superset superset fab list-users
```

### PostgreSQL (Superset metadata)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
docker exec -it superset-db psql -U superset -d superset

# –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
docker exec superset-db psql -U superset -d superset -c "\dt"

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å databases
docker exec superset-db psql -U superset -d superset -c "SELECT * FROM dbs;"
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Lab 6:

- ‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞—Ö
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π pipeline: –°–±–æ—Ä ‚Üí –•—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ batch (Hive) –∏ streaming (Pinot) –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω –∞–∫—Ç–∏–≤–æ–≤

**–ì–æ—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏!** üéâ

---

## üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Apache Pinot Documentation](https://docs.pinot.apache.org/)
- [Apache Superset Documentation](https://superset.apache.org/docs/intro)
- [Pinot SQL Reference](https://docs.pinot.apache.org/users/user-guide-query/querying-pinot)
- [Superset Chart Types](https://superset.apache.org/docs/configuration/configuring-superset)

---

## üë• –ê–≤—Ç–æ—Ä—ã

–°—Ç—É–¥–µ–Ω—Ç—ã –ú–ò–§–ò, –∫—É—Ä—Å "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö"

---

## üìù –ü–æ–ª–Ω—ã–π Pipeline –ø—Ä–æ–µ–∫—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MOEX Data Pipeline                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Lab 1-2: Data Collection
  ‚îú‚îÄ MOEX API ‚Üí Kotlin Collector ‚Üí Kafka
  ‚îî‚îÄ Topics: moex.trades, moex.instruments

Lab 3: Data Storage
  ‚îú‚îÄ Kafka ‚Üí NiFi ‚Üí HDFS
  ‚îî‚îÄ HDFS ‚Üí Hive tables (moex_data.trades)

Lab 4: Batch Processing
  ‚îú‚îÄ Hive ‚Üí MapReduce (Hadoop YARN)
  ‚îî‚îÄ Output: trade_volumes_hourly

Lab 5: Stream Processing
  ‚îú‚îÄ Kafka ‚Üí Spark Streaming
  ‚îî‚îÄ Output: moex.current_prices (Kafka)

Lab 6: Visualization ‚≠ê
  ‚îú‚îÄ Hive (batch) ‚Üí Superset Dashboards
  ‚îú‚îÄ Kafka ‚Üí Pinot (real-time) ‚Üí Superset Dashboards
  ‚îî‚îÄ Interactive dashboards with auto-refresh

üéâ Complete Big Data Pipeline!
```
